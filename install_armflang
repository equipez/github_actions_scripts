#!/usr/bin/env bash
# Install Arm Fortran Compiler (armflang) on a Linux system.
# Usage: ./install_armflang

set -euo pipefail

# Make module command available
sudo apt update
sudo apt install -y environment-modules curl

# Create a custom curl wrapper to enforce HTTP/1.1 and IPv4, with retries and timeouts.
mkdir -p "$HOME/bin" && cat >"$HOME/bin/curl" <<'EOF'
#!/usr/bin/env bash
exec /usr/bin/curl --http1.1 -4 -L -C - --retry 5 --retry-connrefused --retry-delay 5 --no-keepalive --limit-rate 50M --connect-timeout 30 --max-time 1800 "$@"
EOF
chmod +x "$HOME/bin/curl"
export PATH="$HOME/bin:$PATH"
which curl

# Install Arm Fortran Compiler
# See https://developer.arm.com/Tools%20and%20Software/Arm%20Compiler%20for%20Linux#Downloads
# It fails very often due to network issues, so we retry until it works.
until ( printf '\n\n\nyes\n' ) | bash <(curl -fsSL https://developer.arm.com/-/cdn-downloads/permalink/Arm-Compiler-for-Linux/Package/install.sh) ; do
    echo "Retrying Arm Fortran Compiler installation in 10 seconds ..."
    sleep 10
done

# Initialize module command
if [ -f /usr/share/modules/init/bash ]; then
    source /usr/share/modules/init/bash
elif [ -f /etc/profile.d/modules.sh ]; then
    source /etc/profile.d/modules.sh
else
    echo "Warning: Module initialization script not found." >&2
fi

# Add Arm modulefiles
module use /opt/arm/modulefiles

# List available modules
module avail

# Load Arm C and Fortran compiler module
module load acfl
# Load Arm Performance Libraries module
module load armpl

# Verify installation
echo "Arm Fortran Compiler (armflang) information:"
which armflang
armflang --version

# Export relevant environment variables for GitHub Actions
env | grep -i 'arm\|flang\|acfl' >> "$GITHUB_ENV"
