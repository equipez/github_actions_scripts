#!/usr/bin/env bash
# Install Arm Fortran Compiler (armflang) on a Linux system.
# Usage: ./install_armflang

set -uo pipefail

# Make module command available
# Allow update to fail (|| true) but proceed to install
sudo apt update || true
sudo apt install -y environment-modules curl

# Make a temp directory and move into it
TMP_DIR="$(mktemp -d)"
cleanup() {
    # Only remove if it still exists
    [[ -n "${TMP_DIR:-}" && -d "${TMP_DIR}" ]] && rm -rf -- "${TMP_DIR}"
    TMP_DIR=""  # Prevent double cleanup
}

trap cleanup EXIT

echo "Created temporary directory: ${TMP_DIR}"
cd "${TMP_DIR}" || exit 1
echo "Changed to ${TMP_DIR}"

# Create a custom curl wrapper to enforce HTTP/1.1 and IPv4, with retries and timeouts.
cat >"$TMP_DIR/curl" <<'EOF'
#!/usr/bin/env bash
exec /usr/bin/curl --http1.1 -4 -L -C - --retry 5 --retry-connrefused --retry-delay 5 --no-keepalive --limit-rate 50M --connect-timeout 30 --max-time 1800 "$@"
EOF
chmod +x "$TMP_DIR/curl"
export PATH="$TMP_DIR:$PATH"
type curl

# Install Arm Fortran Compiler
# See https://developer.arm.com/Tools%20and%20Software/Arm%20Compiler%20for%20Linux#Downloads
# It fails very often due to network issues, so we retry until it works.
# We retry for at most $RETRY_MAX times with a delay of $RETRY_DELAY seconds between attempts.
RETRY_TIMES=0
RETRY_MAX=10
RETRY_DELAY=5  # seconds

until false; do

    ( printf '\n\n\nyes\n' ) | bash <(curl -fsSL https://developer.arm.com/-/cdn-downloads/permalink/Arm-Compiler-for-Linux/Package/install.sh)

    # Initialize module command
    if [ -f /usr/share/modules/init/bash ]; then
        source /usr/share/modules/init/bash
    elif [ -f /etc/profile.d/modules.sh ]; then
        source /etc/profile.d/modules.sh
    else
        echo "Warning: Module initialization script not found." >&2
    fi

    # Add Arm modulefiles
    module use /opt/arm/modulefiles

    # List available modules
    module avail

    # Load Arm C and Fortran compiler module
    module load acfl
    # Load Arm Performance Libraries module
    module load armpl

    # Verify installation
    type armflang > /dev/null 2>&1 && break || echo "armflang not found after the installation, which probably failed." >&2

    RETRY_TIMES=$((RETRY_TIMES + 1))

    if [ $RETRY_TIMES -ge $RETRY_MAX ]; then
        echo "Error: Installation failed after $RETRY_TIMES attempts." >&2
        exit 1
    else
        echo "Retrying in $RETRY_DELAY seconds ... (Attempt: $RETRY_TIMES)"
        sleep $RETRY_DELAY
    fi

done

# Final messages
echo "Arm Fortran Compiler installation completed."
echo -e "\nThe armflang version is:\n"
armflang --version
echo -e "\nThe path to armflang is:\n"
command -v armflang

# Export relevant environment variables for GitHub Actions
env | grep -i 'arm\|flang\|acfl' >> "$GITHUB_ENV"

# Cleanup is handled by trap on EXIT
